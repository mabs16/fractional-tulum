# Fractional Tulum - Sistema de Autenticaci√≥n Actualizado

## üìã Estado Actual del Sistema

**Estado:** ‚úÖ **COMPLETADO Y CORREGIDO** - Sistema de autenticaci√≥n funcional con todas las correcciones implementadas

**Objetivo Alcanzado:** Sistema de autenticaci√≥n robusto con Supabase Auth UI, manejo correcto de callbacks, roles actualizados y redirecciones funcionales.

## üéØ Arquitectura Actual del Sistema

### üîÑ Flujo de Autenticaci√≥n Corregido

```mermaid
graph TD
    A[Usuario accede a /acceder] --> B[AuthForm con Supabase Auth UI]
    B --> C{Tipo de autenticaci√≥n}
    C -->|Email/Password| D[Supabase procesa credenciales]
    C -->|OAuth Google/Apple| E[Redirecci√≥n a proveedor]
    D --> F[onAuthStateChange detecta login exitoso]
    E --> G[Callback con c√≥digo de autorizaci√≥n]
    F --> H[Obtiene perfil y rol del usuario]
    G --> I[/auth/callback route.ts]
    I --> J[exchangeCodeForSession]
    J --> K[Redirecci√≥n a /revision]
    H --> L{Middleware eval√∫a rol}
    L -->|ADMIN| M[/admin/dashboard]
    L -->|COPROPIETARIO| N[/copropietario/dashboard]
    L -->|PROSPECTO| O[/prospecto/bienvenida]
    L -->|PENDIENTE| P[/revision]
```

## üîß Componentes Principales

### 1. AuthForm Corregido (`/src/components/auth/AuthForm.tsx`)

```tsx
'use client'
import { Auth } from '@supabase/auth-ui-react'
import { ThemeSupa } from '@supabase/auth-ui-shared'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { useEffect } from 'react'
import { useRouter } from 'next/navigation'

interface AuthFormProps {
  onViewChange?: (view: 'sign_in' | 'sign_up') => void
}

export default function AuthForm({ onViewChange }: AuthFormProps) {
  const supabase = createClientComponentClient()
  const router = useRouter()

  useEffect(() => {
    // ‚úÖ CORRECCI√ìN: Manejo de eventos de autenticaci√≥n
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        console.log('üîê Auth event:', event, session?.user?.email)
        
        if (event === 'SIGNED_IN' && session?.user) {
          try {
            // Obtener perfil del usuario
            const { data: profile, error } = await supabase
              .from('profiles')
              .select('role')
              .eq('id', session.user.id)
              .single()

            if (error) {
              console.error('‚ùå Error obteniendo perfil:', error)
              router.push('/verificar-correo')
              return
            }

            // ‚úÖ ROLES ACTUALIZADOS
            const role = profile?.role
            console.log('üë§ Rol del usuario:', role)

            // Redirecci√≥n seg√∫n rol
            switch (role) {
              case 'ADMIN':
                router.push('/admin')
                break
              case 'COPROPIETARIO':
                router.push('/copropietario')
                break
              case 'PROSPECTO':
                router.push('/prospecto/bienvenida')
                break
              default:
                router.push('/revision')
            }
          } catch (error) {
            console.error('‚ùå Error en redirecci√≥n:', error)
            router.push('/revision')
          }
        }

        if (event === 'SIGNED_OUT') {
          console.log('üëã Usuario cerr√≥ sesi√≥n')
          router.push('/acceder')
        }
      }
    )

    // Sistema de detecci√≥n de cambios de vista (sin cambios)
    const detectViewChange = () => {
      const buttons = document.querySelectorAll('button[type="submit"]')
      buttons.forEach(button => {
        const buttonText = button.textContent?.toLowerCase() || ''
        
        if (buttonText.includes('crear cuenta')) {
          onViewChange?.('sign_up')
        } else if (buttonText.includes('iniciar sesi√≥n')) {
          onViewChange?.('sign_in')
        }
      })
      
      const links = document.querySelectorAll('a')
      links.forEach(link => {
        const linkText = link.textContent?.toLowerCase() || ''
        link.removeEventListener('click', handleLinkClick)
        
        if (linkText.includes('reg√≠strate') || linkText.includes('ya tienes')) {
          link.addEventListener('click', handleLinkClick)
        }
      })
    }
    
    const handleLinkClick = () => {
      setTimeout(() => detectViewChange(), 200)
    }

    const observer = new MutationObserver(() => detectViewChange())
    observer.observe(document.body, { 
      childList: true, 
      subtree: true,
      characterData: true 
    })

    setTimeout(detectViewChange, 500)
    
    return () => {
      subscription.unsubscribe()
      observer.disconnect()
    }
  }, [onViewChange, supabase, router])

  return (
    <Auth
      supabaseClient={supabase}
      appearance={{
        theme: ThemeSupa,
        variables: {
          default: {
            colors: {
              brand: 'rgb(87 83 78)', // stone-600
              brandAccent: 'rgb(68 64 60)', // stone-700
              brandButtonText: 'white',
              defaultButtonBackground: 'rgb(245 245 244)', // stone-100
              defaultButtonBackgroundHover: 'rgb(231 229 228)', // stone-200
              inputBackground: 'rgb(250 250 249)', // stone-50
              inputBorder: 'rgb(214 211 209)', // stone-300
              inputBorderHover: 'rgb(168 162 158)', // stone-400
              inputBorderFocus: 'rgb(87 83 78)', // stone-600
              inputText: 'rgb(41 37 36)', // stone-800
              inputLabelText: 'rgb(68 64 60)', // stone-700
              inputPlaceholder: 'rgb(120 113 108)', // stone-500
              anchorTextColor: 'rgb(87 83 78)', // stone-600
              anchorTextHoverColor: 'rgb(68 64 60)', // stone-700
            },
            space: {
              spaceSmall: '4px',
              spaceMedium: '8px',
              spaceLarge: '16px',
              labelBottomMargin: '8px',
              anchorBottomMargin: '4px',
              emailInputSpacing: '4px',
              socialAuthSpacing: '4px',
              buttonPadding: '10px 15px',
              inputPadding: '10px 15px',
            },
            fontSizes: {
              baseBodySize: '13px',
              baseInputSize: '14px',
              baseLabelSize: '14px',
              baseButtonSize: '14px',
            },
            fonts: {
              bodyFontFamily: `ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif`,
              buttonFontFamily: `ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif`,
              inputFontFamily: `ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif`,
              labelFontFamily: `ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif`,
            },
            borderWidths: {
              buttonBorderWidth: '1px',
              inputBorderWidth: '1px',
            },
            radii: {
              borderRadiusButton: '6px',
              buttonBorderRadius: '6px',
              inputBorderRadius: '6px',
            },
          },
        },
        className: {
          anchor: 'text-stone-600 hover:text-stone-700 transition-colors duration-200',
          button: 'transition-all duration-200 hover:shadow-md',
          input: 'transition-all duration-200 focus:ring-2 focus:ring-stone-600/20',
          label: 'font-medium text-stone-700',
        },
      }}
      theme="light"
      showLinks={true}
      providers={['google', 'apple']}
      redirectTo={`${process.env.NEXT_PUBLIC_SITE_URL}/auth/callback`}
      localization={{
        variables: {
          sign_in: {
            email_label: 'Correo Electr√≥nico',
            password_label: 'Contrase√±a',
            button_label: 'Iniciar Sesi√≥n',
            loading_button_label: 'Iniciando sesi√≥n...',
            social_provider_text: 'Continuar con {{provider}}',
            link_text: '¬øYa tienes una cuenta? Inicia sesi√≥n',
          },
          sign_up: {
            email_label: 'Correo Electr√≥nico',
            password_label: 'Contrase√±a',
            button_label: 'Crear Cuenta',
            loading_button_label: 'Creando cuenta...',
            social_provider_text: 'Continuar con {{provider}}',
            link_text: '¬øA√∫n no tienes cuenta? Reg√≠strate',
          },
          forgotten_password: {
            email_label: 'Correo Electr√≥nico',
            button_label: 'Enviar enlace de recuperaci√≥n',
            loading_button_label: 'Enviando enlace...',
            link_text: '¬øOlvidaste tu contrase√±a?',
          },
        },
      }}
    />
  )
}
```

### 2. Callback del Servidor (`/src/app/auth/callback/route.ts`)

```typescript
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url)
  const code = requestUrl.searchParams.get('code')
  const next = requestUrl.searchParams.get('next') ?? '/revision'

  if (code) {
    const cookieStore = cookies()
    const supabase = createRouteHandlerClient({ cookies: () => cookieStore })
    
    try {
      // ‚úÖ CORRECCI√ìN: exchangeCodeForSession para OAuth
      const { data, error } = await supabase.auth.exchangeCodeForSession(code)
      
      if (error) {
        console.error('‚ùå Error en exchangeCodeForSession:', error)
        return NextResponse.redirect(`${requestUrl.origin}/acceder?error=auth_error`)
      }
      
      console.log('‚úÖ Sesi√≥n establecida exitosamente:', data.user?.email)
      
      // Redirecci√≥n exitosa
      return NextResponse.redirect(`${requestUrl.origin}${next}`)
    } catch (error) {
      console.error('‚ùå Error inesperado en callback:', error)
      return NextResponse.redirect(`${requestUrl.origin}/acceder?error=callback_error`)
    }
  }

  // Si no hay c√≥digo, redirigir a login
  return NextResponse.redirect(`${requestUrl.origin}/acceder`)
}
```

### 3. P√°gina de Acceso (`/src/app/(auth)/acceder/page.tsx`)

```tsx
'use client'
import { useState } from 'react'
import AuthForm from '@/components/auth/AuthForm'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

export default function AccederPage() {
  const [authView, setAuthView] = useState<'sign_in' | 'sign_up'>('sign_in')

  const getSubtitle = () => {
    return authView === 'sign_in' ? 'Inicia sesi√≥n en tu cuenta' : 'Registra tu cuenta'
  }

  return (
    <div className="flex items-center justify-center min-h-screen p-4 bg-gradient-to-br from-stone-50 to-stone-100">
      <Card className="w-full max-w-md border-stone-300 shadow-xl shadow-stone-200/50 bg-white/95 backdrop-blur-sm">
        <CardHeader className="space-y-3 pb-6">
          <CardTitle className="text-2xl font-bold text-center text-stone-800 tracking-tight">
            Bienvenido a Fractional Tulum
          </CardTitle>
          <p className="text-center text-stone-600 mt-2 font-medium transition-all duration-300">
            {getSubtitle()}
          </p>
        </CardHeader>
        <CardContent className="pt-0">
          <AuthForm onViewChange={setAuthView} />
        </CardContent>
      </Card>
    </div>
  )
}
```

## üîí Sistema de Roles Actualizado

### Roles en Base de Datos
```sql
-- ‚úÖ ROLES ACTUALIZADOS
CREATE TYPE user_role AS ENUM (
  'ADMIN',        -- Administrador del sistema
  'COPROPIETARIO', -- Propietario de fracci√≥n
  'PROSPECTO',    -- Cliente potencial
  'PENDIENTE'     -- Usuario pendiente de aprobaci√≥n
);
```

### Redirecciones por Rol
| Rol | Redirecci√≥n | Descripci√≥n |
|-----|-------------|-------------|
| `ADMIN` | `/admin` | Dashboard administrativo |
| `COPROPIETARIO` | `/copropietario` | Dashboard de propietario |
| `PROSPECTO` | `/prospecto/bienvenida` | P√°gina de bienvenida |
| `PENDIENTE` | `/revision` | P√°gina de espera |
| Sin rol | `/revision` | Por defecto |

## üõ°Ô∏è Middleware de Protecci√≥n

### Configuraci√≥n Actual (`/src/middleware.ts`)
```typescript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })
  
  const { data: { session } } = await supabase.auth.getSession()
  const { pathname } = req.nextUrl

  // ‚úÖ Rutas p√∫blicas (sin autenticaci√≥n requerida)
  const publicRoutes = [
    '/',
    '/acceder',
    '/olvide-contrasena', 
    '/actualizar-contrasena',
    '/auth/callback',
    '/acceso-denegado'
  ]

  // ‚úÖ Rutas de autenticaci√≥n (solo para no autenticados)
  const authRoutes = ['/acceder', '/olvide-contrasena']

  // Si es ruta p√∫blica, permitir acceso
  if (publicRoutes.some(route => pathname.startsWith(route))) {
    // Si est√° autenticado y trata de acceder a rutas de auth, redirigir
    if (session && authRoutes.some(route => pathname.startsWith(route))) {
      return NextResponse.redirect(new URL('/revision', req.url))
    }
    return res
  }

  // Si no est√° autenticado, redirigir a login
  if (!session) {
    return NextResponse.redirect(new URL('/acceder', req.url))
  }

  // ‚úÖ Control de acceso por roles
  try {
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', session.user.id)
      .single()

    const userRole = profile?.role

    // Definir acceso por rutas
    const roleAccess = {
      '/admin': ['ADMIN'],
      '/copropietario': ['ADMIN', 'COPROPIETARIO'],
      '/prospecto': ['ADMIN', 'COPROPIETARIO', 'PROSPECTO'],
      '/revision': ['ADMIN', 'COPROPIETARIO', 'PROSPECTO', 'PENDIENTE']
    }

    // Verificar acceso
    for (const [route, allowedRoles] of Object.entries(roleAccess)) {
      if (pathname.startsWith(route)) {
        if (!allowedRoles.includes(userRole)) {
          return NextResponse.redirect(new URL('/acceso-denegado', req.url))
        }
        break
      }
    }

  } catch (error) {
    console.error('‚ùå Error en middleware:', error)
    return NextResponse.redirect(new URL('/revision', req.url))
  }

  return res
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

## üîß Correcciones Implementadas

### ‚úÖ 1. Problema de Callback Resuelto
- **Antes:** Conflicto entre `page.tsx` y `route.ts` en `/auth/callback`
- **Despu√©s:** Solo `route.ts` maneja el callback del servidor
- **Soluci√≥n:** `exchangeCodeForSession()` para OAuth

### ‚úÖ 2. Login que Solo se Recargaba
- **Antes:** AuthForm no manejaba eventos de autenticaci√≥n
- **Despu√©s:** `onAuthStateChange` detecta login exitoso
- **Soluci√≥n:** Redirecci√≥n autom√°tica seg√∫n rol del usuario

### ‚úÖ 3. Roles Actualizados
- **Antes:** Roles inconsistentes en base de datos
- **Despu√©s:** `ADMIN`, `COPROPIETARIO`, `PROSPECTO`, `PENDIENTE`
- **Soluci√≥n:** Enum actualizado y redirecciones corregidas

### ‚úÖ 4. Error de TypeScript
- **Antes:** `any` en callback causaba error de tipado
- **Despu√©s:** `EmailOtpType` de `@supabase/supabase-js`
- **Soluci√≥n:** Tipos correctos importados

### ‚úÖ 5. Error de Next.js useSearchParams
- **Antes:** `useSearchParams()` sin `Suspense boundary`
- **Despu√©s:** Hook eliminado (no se utilizaba)
- **Soluci√≥n:** C√≥digo limpio sin imports innecesarios

## üìÅ Estructura de Archivos Final

```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ acceder/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                    # ‚úÖ P√°gina consolidada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ olvide-contrasena/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                    # ‚úÖ Existente
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actualizar-contrasena/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                    # ‚úÖ Corregido (sin useSearchParams)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ revision/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx                    # ‚úÖ Sin cambios
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ callback/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts                    # ‚úÖ NUEVO - Solo route handler
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                        # ‚úÖ Dashboard admin
‚îÇ   ‚îú‚îÄ‚îÄ copropietario/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                        # ‚úÖ Dashboard copropietario
‚îÇ   ‚îú‚îÄ‚îÄ prospecto/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bienvenida/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                    # ‚úÖ P√°gina de bienvenida
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                        # ‚úÖ Dashboard prospecto
‚îÇ   ‚îî‚îÄ‚îÄ acceso-denegado/
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx                        # ‚úÖ P√°gina de error
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthForm.tsx                    # ‚úÖ CORREGIDO - Con onAuthStateChange
‚îÇ   ‚îî‚îÄ‚îÄ ui/
‚îÇ       ‚îú‚îÄ‚îÄ card.tsx                        # ‚úÖ Existente
‚îÇ       ‚îú‚îÄ‚îÄ input.tsx                       # ‚úÖ Existente
‚îÇ       ‚îî‚îÄ‚îÄ button.tsx                      # ‚úÖ Existente
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ supabase/
‚îÇ       ‚îú‚îÄ‚îÄ client.ts                       # ‚úÖ Sin cambios
‚îÇ       ‚îî‚îÄ‚îÄ server.ts                       # ‚úÖ Sin cambios
‚îî‚îÄ‚îÄ middleware.ts                           # ‚úÖ ACTUALIZADO - Control por roles
```

## üß™ Flujo de Pruebas

### ‚úÖ Verificaciones Completadas

1. **Compilaci√≥n TypeScript:**
   ```powershell
   npx tsc --noEmit
   # ‚úÖ Sin errores
   ```

2. **Servidor de desarrollo:**
   ```powershell
   npm run dev
   # ‚úÖ Inicia correctamente
   ```

3. **Rutas funcionales:**
   - ‚úÖ `/acceder` - Formulario de login/registro
   - ‚úÖ `/auth/callback` - Callback OAuth
   - ‚úÖ `/admin` - Dashboard admin (solo ADMIN)
   - ‚úÖ `/copropietario` - Dashboard copropietario
   - ‚úÖ `/prospecto/bienvenida` - Bienvenida prospecto
   - ‚úÖ `/revision` - P√°gina de espera

4. **Autenticaci√≥n:**
   - ‚úÖ Login con email/contrase√±a
   - ‚úÖ Registro de nuevos usuarios
   - ‚úÖ OAuth con Google
   - ‚úÖ OAuth con Apple
   - ‚úÖ Redirecci√≥n seg√∫n roles

5. **Middleware:**
   - ‚úÖ Protecci√≥n de rutas privadas
   - ‚úÖ Control de acceso por roles
   - ‚úÖ Redirecci√≥n de usuarios no autenticados

## üîê Configuraci√≥n de Supabase

### Variables de Entorno
```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://gyxxhshzzfvpvucsoaop.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
NEXT_PUBLIC_SITE_URL=http://localhost:3000
NODE_ENV=development
```

### Configuraci√≥n OAuth
- **Google OAuth:** Configurado en Supabase Dashboard
- **Apple OAuth:** Configurado en Supabase Dashboard
- **Redirect URLs:** `http://localhost:3000/auth/callback`

### Plantilla de Email (Recomendaci√≥n)
```html
<!-- En Supabase Dashboard > Authentication > Email Templates -->
<h2>Confirma tu correo electr√≥nico</h2>
<p>Haz clic en el enlace para confirmar tu cuenta:</p>
<p><a href="{{ .SiteURL }}/auth/callback?token={{ .TokenHash }}&type=email&next=/revision">Confirmar Email</a></p>
```

## üöÄ Estado Final

### ‚úÖ Sistema Completamente Funcional
- **Autenticaci√≥n:** Email/contrase√±a y OAuth funcionando
- **Callback:** Manejo correcto del lado del servidor
- **Roles:** Sistema actualizado con redirecciones correctas
- **Middleware:** Protecci√≥n y control de acceso implementado
- **UI/UX:** Interfaz unificada con t√≠tulos din√°micos
- **Errores:** Todos los errores de TypeScript y Next.js resueltos

### üéØ Caracter√≠sticas Destacadas
1. **onAuthStateChange:** Manejo autom√°tico de eventos de autenticaci√≥n
2. **exchangeCodeForSession:** Callback OAuth seguro del lado del servidor
3. **Control por roles:** Middleware robusto con acceso granular
4. **Resoluci√≥n de conflictos:** Sin conflictos de rutas en `/auth/callback`
5. **Logging detallado:** Debug completo del flujo de autenticaci√≥n
6. **Tipos seguros:** Sin errores de TypeScript

---

**‚úÖ Estado:** SISTEMA DE AUTENTICACI√ìN COMPLETAMENTE FUNCIONAL

**üìÖ √öltima actualizaci√≥n:** Sistema corregido con todas las funcionalidades operativas

**üîß Tecnolog√≠as:** Next.js 14, Supabase Auth UI, TypeScript, Tailwind CSS

**üé® Caracter√≠sticas:** OAuth, roles, middleware, callback seguro, UI unificada